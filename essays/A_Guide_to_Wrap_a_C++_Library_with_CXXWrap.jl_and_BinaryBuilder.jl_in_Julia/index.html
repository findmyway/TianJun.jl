<!DOCTYPE html>
<html lang="en-US"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>A Guide to Wrap a C++ Library with CxxWrap.jl and BinaryBuilder.jl in Julia ¬∑ Jun Tian</title><meta name="title" content="A Guide to Wrap a C++ Library with CxxWrap.jl and BinaryBuilder.jl in Julia ¬∑ Jun Tian"/><meta property="og:title" content="A Guide to Wrap a C++ Library with CxxWrap.jl and BinaryBuilder.jl in Julia ¬∑ Jun Tian"/><meta property="twitter:title" content="A Guide to Wrap a C++ Library with CxxWrap.jl and BinaryBuilder.jl in Julia ¬∑ Jun Tian"/><meta name="description" content="Documentation for Jun Tian."/><meta property="og:description" content="Documentation for Jun Tian."/><meta property="twitter:description" content="Documentation for Jun Tian."/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-132847825-3"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-132847825-3', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.jpg" alt="Jun Tian logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Jun Tian</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">üëã About</a></li><li><span class="tocitem">üíª Programming</span><ul><li><a class="tocitem" href="../../programming/A_Deep_Dive_into_Distributed.jl/">A Deep Dive into Distributed.jl</a></li></ul></li><li><span class="tocitem">üìñ Reading</span><ul><li><a class="tocitem" href="../../reading/Notes_on_Distributional_Reinforcement_Learning/">Notes on Distributional Reinforcement Learning</a></li></ul></li><li><a class="tocitem" href="../../AMA/">üôã Ask Me Anything</a></li><li><a class="tocitem" href="../../blogroll/">üîó Blogroll</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>A Guide to Wrap a C++ Library with CxxWrap.jl and BinaryBuilder.jl in Julia</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>A Guide to Wrap a C++ Library with CxxWrap.jl and BinaryBuilder.jl in Julia</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/findmyway/TianJun.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/findmyway/TianJun.jl/blob/master/docs/src/essays/A_Guide_to_Wrap_a_C++_Library_with_CXXWrap.jl_and_BinaryBuilder.jl_in_Julia/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><hr/><p>keywords: Julia,C++ CJKmainfont: KaiTi ‚Äì-</p><h1 id="A-Guide-to-Wrap-a-C-Library-with-CxxWrap.jl-and-BinaryBuilder.jl-in-Julia"><a class="docs-heading-anchor" href="#A-Guide-to-Wrap-a-C-Library-with-CxxWrap.jl-and-BinaryBuilder.jl-in-Julia">A Guide to Wrap a C++ Library with CxxWrap.jl and BinaryBuilder.jl in Julia</a><a id="A-Guide-to-Wrap-a-C-Library-with-CxxWrap.jl-and-BinaryBuilder.jl-in-Julia-1"></a><a class="docs-heading-anchor-permalink" href="#A-Guide-to-Wrap-a-C-Library-with-CxxWrap.jl-and-BinaryBuilder.jl-in-Julia" title="Permalink"></a></h1><p>The following parts are not covered here:</p><ol><li>How to write the wrapper code in C++. (It is detailed <a href="https://github.com/JuliaInterop/CxxWrap.jl">here</a>. And I find the <a href="https://github.com/JuliaInterop/libcxxwrap-julia/tree/master/examples">examples</a> are also very useful!)</li></ol><p>And you will learn the following parts after reading this post.</p><ol><li>How to quickly debug your code?</li><li>The missing parts that are not documented in <a href="https://github.com/JuliaPackaging/BinaryBuilder.jl">BinaryBuilder.jl</a> and <a href="https://github.com/JuliaInterop/CxxWrap.jl">CxxWrap.jl</a></li></ol><h2 id="Prepare"><a class="docs-heading-anchor" href="#Prepare">Prepare</a><a id="Prepare-1"></a><a class="docs-heading-anchor-permalink" href="#Prepare" title="Permalink"></a></h2><p>First things first. Suppose you want to write a Julia wrapper for a C++ package (I&#39;ll take the one I wrote, <a href="https://github.com/PaddlePaddle/VisualDL">VisualDL</a>, for example). You need to fork that repo into your own account and clone that repo to your local computer. Then install necessary dependencies according to the document and make sure you can compile it successfully.</p><p>The next step is to write the wrapper code. Usually you would like to add a flag in the <code>CMakeLists.txt</code> file to signafy whether to build the Julia wrapper or not. Like <a href="https://github.com/findmyway/VisualDL/blob/julia/CMakeLists.txt#L37">this</a></p><pre><code class="nohighlight hljs">option(WITH_JULIA       &quot;Compile VisualDL with Julia&quot;               OFF)</code></pre><p>Then make a seperate folder containing all your source codes and corresponding <code>CMakeLists.txt</code>. And include that folder in the root <code>CMakeLists.txt</code> file. Like <a href="https://github.com/findmyway/VisualDL/blob/julia/CMakeLists.txt#L76-L78">this</a></p><pre><code class="nohighlight hljs">if(WITH_JULIA)
  add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/visualdl/julia)
endif()</code></pre><p>For the simplest case, only a <code>CMakeLists.txt</code> file and <code>your_wrapper_code.cc</code> are needed. Like <a href="https://github.com/findmyway/VisualDL/tree/julia/visualdl/julia">this</a></p><p>Following the instructions from <a href="https://github.com/JuliaInterop/CxxWrap.jl">CxxWrap.jl</a>, you should find it easy to write the wrapper codes. If the project you are working on already has a python wrapper, I strongly suggest you to take look at it first. And it will save you a lot of time.</p><p>Then you need to specify how to build your target in the <code>CMakeLists.txt</code>, for <a href="https://github.com/findmyway/VisualDL/blob/julia/visualdl/julia/CMakeLists.txt">example</a>:</p><pre><code class="nohighlight hljs"># 1. find JlCxx

find_package(JlCxx REQUIRED)

# 2. add libraries and dependencies

add_library(im ${PROJECT_SOURCE_DIR}/visualdl/logic/im.cc)
add_library(sdk ${PROJECT_SOURCE_DIR}/visualdl/logic/sdk.cc ${PROJECT_SOURCE_DIR}/visualdl/utils/image.h)
add_dependencies(im storage_proto)
add_dependencies(sdk entry binary_record storage storage_proto eigen3)
add_library(vdljl SHARED vdljl.cc)
add_dependencies(vdljl im entry tablet sdk storage protobuf eigen3)

# 3. specify targets

target_link_libraries(vdljl PRIVATE JlCxx::cxxwrap_julia entry binary_record im tablet storage sdk protobuf ${OPTIONAL_LINK_FLAGS})

# 4. install

install(TARGETS vdljl
    RUNTIME DESTINATION lib
    ARCHIVE DESTINATION lib
    LIBRARY DESTINATION lib)</code></pre><h2 id="Local-Debug"><a class="docs-heading-anchor" href="#Local-Debug">Local Debug</a><a id="Local-Debug-1"></a><a class="docs-heading-anchor-permalink" href="#Local-Debug" title="Permalink"></a></h2><p>Now you have finished all the necessary changes to the original package, you may want to get the compiled library.</p><p>Let&#39;s install <code>CxxWrap</code> in Julia first. Enter the package mode and add <code>CxxWrap</code></p><pre><code class="language-julia hljs">(v1.1) pkg&gt; add CxxWrap</code></pre><p>Now you have <code>CxxWrap</code> and the underlying <a href="https://github.com/JuliaInterop/libcxxwrap-julia"><code>libcxxwrap-julia</code></a> installed. We can print the library path and the cmake file path:</p><pre><code class="language-julia hljs">julia&gt; using CxxWrap

julia&gt; CxxWrap.jlcxx_path
&quot;/home/tj/.julia/packages/CxxWrap/KcmSi/deps/usr/lib/libcxxwrap_julia.so&quot;

julia&gt; julia&gt; readdir(joinpath(dirname(CxxWrap.jlcxx_path), &quot;cmake&quot;, &quot;JlCxx&quot;))
5-element Array{String,1}:
 &quot;FindJulia.cmake&quot;
 &quot;JlCxxConfig.cmake&quot;
 &quot;JlCxxConfigExports-release.cmake&quot;
 &quot;JlCxxConfigExports.cmake&quot;
 &quot;JlCxxConfigVersion.cmake&quot;</code></pre><p>What we are interested in here is the the path of <code>joinpath(dirname(CxxWrap.jlcxx_path), &quot;cmake&quot;, &quot;JlCxx&quot;)</code> (Here is the <code>/home/tj/.julia/packages/CxxWrap/KcmSi/deps/usr/lib/cmake/JlCxx</code>). Now we can compile the package with <code>JlCxx_DIR</code> properly set:</p><pre><code class="nohighlight hljs">$ mkdir build

$ cd build

$ cmake -DWITH_JULIA=ON -DJlCxx_DIR=/home/tj/.julia/packages/CxxWrap/KcmSi/deps/usr/lib/cmake/JlCxx ..

$ make

$ make install</code></pre><p>Then you can load the compiled library in the Julia REPL for testing:</p><pre><code class="language-julia hljs">module VisualDL
  using CxxWrap
  @wrapmodule(&quot;/absolute/path/to/your/lib&quot;)

  function __init__()
    @initcxx
  end
end

using .VisualDL</code></pre><h2 id="BinaryBuilder"><a class="docs-heading-anchor" href="#BinaryBuilder">BinaryBuilder</a><a id="BinaryBuilder-1"></a><a class="docs-heading-anchor-permalink" href="#BinaryBuilder" title="Permalink"></a></h2><p>In order to leverage the BinaryBuilder, we create an independent repo (for example, <a href="https://github.com/findmyway/VisualDLBuilder">VisualDLBuilder</a>) to build the tarballs. Be careful with the following lines:</p><ol><li>Don&#39;t forget to specify the <code>compiler_abi</code> field in the platforms like <a href="https://github.com/findmyway/VisualDLBuilder/blob/master/build_tarballs.jl#L7">this</a> here, if your code doesn&#39;t compile with old gcc.</li><li>For the <a href="https://github.com/findmyway/VisualDLBuilder/blob/master/build_tarballs.jl#L10"><code>sources</code></a> in the <code>build_tarballs.jl</code>, you can specify an absolute local path pointing to the modified package above for debugging. After making sure that everything works fine, you make a PR then ask the repo owner to tag a new release. And then change this variable into the <code>url =&gt; hash</code> form.</li><li>Do not forget to run <code>make install</code> at the end of <a href="https://github.com/findmyway/VisualDLBuilder/blob/master/build_tarballs.jl#L19">script</a>. Seriously!</li><li>In the <code>dependencies</code> <a href="https://github.com/findmyway/VisualDLBuilder/blob/master/build_tarballs.jl#L26">part</a>, remember to add both CxxWrap and Julia.</li></ol><p>As for the <code>.travis.yml</code> <a href="https://github.com/findmyway/VisualDLBuilder/blob/master/.travis.yml#L21">file</a>, for now you need to specify the <code>MbedTLS</code> to version <code>0.6.6</code> due to the <a href="https://github.com/JuliaWeb/MbedTLS.jl/issues/193">error</a>.</p><p>Althought there&#39;s a helper function in BinaryBuilder.jl named <code>setup_travis</code> to help you set up the deploy step, I never succeed. So I&#39;d suggest you to install <a href="https://github.com/travis-ci/travis.rb#installation">travis cli</a> and run <strong>travis login ‚Äìpro</strong> first!!! Then <code>travis setup releases</code>.</p><h2 id="The-Julia-Wrapper-Package"><a class="docs-heading-anchor" href="#The-Julia-Wrapper-Package">The Julia Wrapper Package</a><a id="The-Julia-Wrapper-Package-1"></a><a class="docs-heading-anchor-permalink" href="#The-Julia-Wrapper-Package" title="Permalink"></a></h2><p>This is the final step. You create a new package. Add the <code>CxxWrap</code> as your dependency. Rename the build file you get by BinaryBuilder to <code>build.jl</code> and put it into the <code>deps</code> folder. And you expect to get the <code>deps.jl</code> after running <code>julia deps/build.jl</code>. Unfortunately, you&#39;ll see an error like this:</p><pre><code class="nohighlight hljs">ERROR: LoadError: LibraryProduct(nothing, [&quot;libvdljl&quot;], :libvdljl, &quot;Prefix(/home/tianjun/tmp/visualdl/deps/usr)&quot;) is not satisfied, cannot generate deps.jl!</code></pre><p>The reason is that we need the shared package of <code>jlcxx</code>. So remember to put <code>using CxxWrap</code> in the first line of <code>build.jl</code>. Then everything should work as you wish.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>. All contents published at this site follows <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a> by default. For the Chinese version, please visit <a href="https://tianjun.me">tianjun.me</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Saturday 23 December 2023 15:51">Saturday 23 December 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
