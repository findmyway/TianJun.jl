<!DOCTYPE html>
<html lang="en-US"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯? Â· Jun Tian</title><meta name="title" content="å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯? Â· Jun Tian"/><meta property="og:title" content="å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯? Â· Jun Tian"/><meta property="twitter:title" content="å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯? Â· Jun Tian"/><meta name="description" content="Documentation for Jun Tian."/><meta property="og:description" content="Documentation for Jun Tian."/><meta property="twitter:description" content="Documentation for Jun Tian."/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-132847825-3"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-132847825-3', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.jpg" alt="Jun Tian logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Jun Tian</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">ğŸ‘‹ About</a></li><li><span class="tocitem">ğŸ’» Programming</span><ul><li><a class="tocitem" href="../../A_Deep_Dive_into_Distributed.jl/">A Deep Dive into Distributed.jl</a></li></ul></li><li><span class="tocitem">ğŸ“– Reading</span><ul><li><a class="tocitem" href="../../../reading/Notes_on_Distributional_Reinforcement_Learning/">Notes on Distributional Reinforcement Learning</a></li></ul></li><li><a class="tocitem" href="../../../AMA/">ğŸ™‹ Ask Me Anything</a></li><li><a class="tocitem" href="../../../blogroll/">ğŸ”— Blogroll</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯?</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯?</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/findmyway/TianJun.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ï‚›</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/findmyway/TianJun.jl/blob/master/docs/src/programming/Dot_Product_in_Julia/index.zh.md" title="Edit source on GitHub"><span class="docs-icon fa-solid">ï„</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯?"><a class="docs-heading-anchor" href="#å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯?">å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯?</a><a id="å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯?-1"></a><a class="docs-heading-anchor-permalink" href="#å¦‚ä½•åœ¨Juliaä¸­è®¡ç®—ç‚¹ç§¯?" title="Permalink"></a></h1><p><em>å›å­—æœ‰å‡ ç§å†™æ³•?</em> ğŸ¤”</p><div class=blogmeta><svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='150' height='20'><linearGradient id='s' x2='0' y2='100%'><stop offset='0' stop-color='#bbb' stop-opacity='.1'/><stop offset='1' stop-opacity='.1'/></linearGradient><clipPath id='r'><rect width='150' height='20' rx='3' fill='#fff'/></clipPath><g clip-path='url(#r)'><rect width='75' height='20' fill='#555'/><rect x='75' width='75' height='20' fill='#97C40F'/><rect width='150' height='20' fill='url(#s)'/></g><g fill='#fff' text-anchor='middle' font-family='Verdana,Geneva,DejaVu Sans,sans-serif' text-rendering='geometricPrecision' font-size='110'><text x='385' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='650'>Last Update</text><text x='385' y='140' transform='scale(.1)' textLength='650'>Last Update</text><text x='1115' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='650'>2021-11-19</text><text x='1115' y='140' transform='scale(.1)' textLength='650'>2021-11-19</text></g></svg><svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='122' height='20'><linearGradient id='s' x2='0' y2='100%'><stop offset='0' stop-color='#bbb' stop-opacity='.1'/><stop offset='1' stop-opacity='.1'/></linearGradient><clipPath id='r'><rect width='122' height='20' rx='3' fill='#fff'/></clipPath><g clip-path='url(#r)'><rect width='47' height='20' fill='#555'/><rect x='47' width='75' height='20' fill='#4c1'/><rect width='122' height='20' fill='url(#s)'/></g><g fill='#fff' text-anchor='middle' font-family='Verdana,Geneva,DejaVu Sans,sans-serif' text-rendering='geometricPrecision' font-size='110'><text x='245' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='370'>Create</text><text x='245' y='140' transform='scale(.1)' textLength='370'>Create</text><text x='835' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='650'>2021-11-16</text><text x='835' y='140' transform='scale(.1)' textLength='650'>2021-11-16</text></g></svg><svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='54' height='20'><linearGradient id='s' x2='0' y2='100%'><stop offset='0' stop-color='#bbb' stop-opacity='.1'/><stop offset='1' stop-opacity='.1'/></linearGradient><clipPath id='r'><rect width='54' height='20' rx='3' fill='#fff'/></clipPath><g clip-path='url(#r)'><rect width='19' height='20' fill='#555'/><rect x='19' width='35' height='20' fill='#0F80C1'/><rect width='54' height='20' fill='url(#s)'/></g><g fill='#fff' text-anchor='middle' font-family='Verdana,Geneva,DejaVu Sans,sans-serif' text-rendering='geometricPrecision' font-size='110'><text x='105' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='90'>#</text><text x='105' y='140' transform='scale(.1)' textLength='90'>#</text><text x='355' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='250'>Julia</text><text x='355' y='140' transform='scale(.1)' textLength='250'>Julia</text></g></svg><svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='60' height='20'><linearGradient id='s' x2='0' y2='100%'><stop offset='0' stop-color='#bbb' stop-opacity='.1'/><stop offset='1' stop-opacity='.1'/></linearGradient><clipPath id='r'><rect width='60' height='20' rx='3' fill='#fff'/></clipPath><g clip-path='url(#r)'><rect width='19' height='20' fill='#555'/><rect x='19' width='41' height='20' fill='#0F80C1'/><rect width='60' height='20' fill='url(#s)'/></g><g fill='#fff' text-anchor='middle' font-family='Verdana,Geneva,DejaVu Sans,sans-serif' text-rendering='geometricPrecision' font-size='110'><text x='105' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='90'>#</text><text x='105' y='140' transform='scale(.1)' textLength='90'>#</text><text x='385' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='310'>CUDA</text><text x='385' y='140' transform='scale(.1)' textLength='310'>CUDA</text></g></svg><svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='52' height='20'><linearGradient id='s' x2='0' y2='100%'><stop offset='0' stop-color='#bbb' stop-opacity='.1'/><stop offset='1' stop-opacity='.1'/></linearGradient><clipPath id='r'><rect width='52' height='20' rx='3' fill='#fff'/></clipPath><g clip-path='url(#r)'><rect width='19' height='20' fill='#555'/><rect x='19' width='33' height='20' fill='#0F80C1'/><rect width='52' height='20' fill='url(#s)'/></g><g fill='#fff' text-anchor='middle' font-family='Verdana,Geneva,DejaVu Sans,sans-serif' text-rendering='geometricPrecision' font-size='110'><text x='105' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='90'>#</text><text x='105' y='140' transform='scale(.1)' textLength='90'>#</text><text x='345' y='150' fill='#010101' fill-opacity='.3' transform='scale(.1)' textLength='230'>GPU</text><text x='345' y='140' transform='scale(.1)' textLength='230'>GPU</text></g></svg></div><p>ä¸¤ä¸ªå‘é‡<span>$\vec{a} = [a_1, a_2, ..., a_n]$</span> å’Œ <span>$\vec{b} = [b_1, b_2, ..., b_n]$</span> ä¹‹é—´ç‚¹ç§¯ï¼ˆdot product)çš„ä»£æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><p class="math-container">\[\vec{a} \cdot \vec{b} = \sum^n_{i=1} a_i b_i = a_1 b_1 + a_2 b_2 + ... + a_n b_n\]</p><p>é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨Juliaä¸­å¿«é€Ÿè®¡ç®—ç‚¹ç§¯å‘¢ï¼Ÿ</p><h2 id="ç‰ˆæœ¬1ï¼š-ä½¿ç”¨-LinearAlgebra-æ ‡å‡†åº“ä¸­çš„-dot-å‡½æ•°"><a class="docs-heading-anchor" href="#ç‰ˆæœ¬1ï¼š-ä½¿ç”¨-LinearAlgebra-æ ‡å‡†åº“ä¸­çš„-dot-å‡½æ•°">ç‰ˆæœ¬1ï¼š ä½¿ç”¨ LinearAlgebra æ ‡å‡†åº“ä¸­çš„ <code>dot</code> å‡½æ•°</a><a id="ç‰ˆæœ¬1ï¼š-ä½¿ç”¨-LinearAlgebra-æ ‡å‡†åº“ä¸­çš„-dot-å‡½æ•°-1"></a><a class="docs-heading-anchor-permalink" href="#ç‰ˆæœ¬1ï¼š-ä½¿ç”¨-LinearAlgebra-æ ‡å‡†åº“ä¸­çš„-dot-å‡½æ•°" title="Permalink"></a></h2><pre><code class="language-julia hljs">julia&gt; using LinearAlgebra

julia&gt; N = 1024*1024
1048576

julia&gt; x, y = rand(N), rand(N);

julia&gt; dot(x,y)
262311.47579656926
</code></pre><p>å…ˆæµ‹è¯•ä¸‹æ ‡å‡†åº“é‡Œ <code>dot</code> çš„æ€§èƒ½ï¼š</p><pre><code class="language-julia hljs">julia&gt; using BenchmarkTools

julia&gt; @benchmark dot($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  244.474 Î¼s â€¦  43.973 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     252.275 Î¼s               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   314.178 Î¼s Â± 884.297 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–‡â–ˆâ–„â–ƒâ–‚â–â–â–â–â–â–â– â–â–‚                                               â–‚
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–‡â–‡â–‡â–‡â–ˆâ–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–†â–†â–…â–†â–‡â–‡â–…â–ƒâ–…â–…â–„â–ƒâ–„â–„â–ƒâ–ƒâ–„â–ƒâ–…â–‡â–ˆâ–ˆâ–†â–…â–…â–ƒâ–„â–â–ƒâ–ƒâ–ƒ â–ˆ
  244 Î¼s        Histogram: log(frequency) by time        594 Î¼s &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>ä¸­é—´å€¼ä½äº252Î¼sé™„è¿‘ã€‚</p><h2 id="ç‰ˆæœ¬2ï¼š-forå¾ªç¯"><a class="docs-heading-anchor" href="#ç‰ˆæœ¬2ï¼š-forå¾ªç¯">ç‰ˆæœ¬2ï¼š forå¾ªç¯</a><a id="ç‰ˆæœ¬2ï¼š-forå¾ªç¯-1"></a><a class="docs-heading-anchor-permalink" href="#ç‰ˆæœ¬2ï¼š-forå¾ªç¯" title="Permalink"></a></h2><p>å½“ç„¶ï¼Œå³ä½¿ä¸ä½¿ç”¨è‡ªå¸¦çš„<code>dot</code>å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç”¨ä¸€ä¸ª <code>for</code> å¾ªç¯æ¥å®ç°ï¼š</p><pre><code class="language-julia hljs">function dot2_1(x, y)
    res = 0
    for i in eachindex(x, y)
        res += x[i] * y[i]
    end
    res
end</code></pre><p>å†™æ³•åŸºæœ¬å’ŒåŸå§‹çš„æ•°å­¦è¡¨è¾¾å¼ä¸€æ ·ï¼Œé‚£æ€§èƒ½å¦‚ä½•å‘¢ï¼Ÿ</p><pre><code class="language-julia hljs">julia&gt; @benchmark dot2_1($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 2134 samples with 1 evaluation.
 Range (min â€¦ max):  2.286 ms â€¦  2.942 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     2.302 ms              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   2.330 ms Â± 56.418 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–ˆ â–ˆ                                                         
  â–ˆâ–ƒâ–ˆâ–‡â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–„â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–â–â–â–‚â–‚â–â–â–â–â–‚â–‚â–‚â–‚â–‚â–â–‚ â–ƒ
  2.29 ms        Histogram: frequency by time         2.6 ms &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>å‘ƒï¼Œ è€—æ—¶å·®ä¸å¤šæ˜¯åŸæ¥çš„9å€äº†ã€‚æœ‰ç‚¹ä¸å¯æ€è®®ï¼Œé‚£æ€ä¹ˆä¼˜åŒ–ä¸‹å‘¢ï¼Ÿ å…ˆç”¨ <code>@code_warntype</code> çœ‹ä¸‹ï¼š</p><p><img src="../code_warntype_dot2_1.png" alt/></p><p>æ³¨æ„åˆ°ä¸Šé¢æ ‡çº¢è‰²çš„éƒ¨åˆ†ï¼Œè¿™æ˜¯æé†’æˆ‘ä»¬ä¸Šé¢çš„å®ç°ä¸­å‡ºç°äº†ç±»å‹ä¸ç¨³å®šçš„æƒ…å†µã€‚ä¸»è¦åŸå› æ˜¯<code>res</code>åœ¨<code>dot2_1</code>å‡½æ•°ä¸­ï¼Œåˆå§‹åŒ–æˆäº†<code>Int64</code>ç±»å‹çš„<code>0</code>ï¼Œè€Œæˆ‘ä»¬çš„è¾“å…¥æ˜¯ä¸¤ä¸ª<code>Vector{Float64}</code>ç±»å‹çš„å‘é‡ã€‚äº†è§£è¿™ä¸€ç‚¹ä¹‹åï¼Œå¯ä»¥æŠŠä¸Šé¢çš„å®ç°å†™å¾—æ›´çµæ´»ä¸€äº›ï¼š</p><pre><code class="language-julia hljs">function dot2_2(x::AbstractArray{X}, y::AbstractArray{Y}) where {X,Y}
    res = zero(promote_type(X,Y))
    for i in eachindex(x, y)
        res += x[i] * y[i]
    end
    res
end</code></pre><p>è¿™é‡Œï¼Œ é€šè¿‡ <code>promote_type</code> è·å–ç±»å‹ä¿¡æ¯ã€‚</p><pre><code class="language-julia hljs">julia&gt; @benchmark dot2_2($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 3384 samples with 1 evaluation.
 Range (min â€¦ max):  1.410 ms â€¦  3.580 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     1.449 ms              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   1.464 ms Â± 66.969 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

         â–† â–ƒâ–ˆ â–„                                               
  â–‚â–ƒâ–ƒâ–ƒâ–…â–ˆâ–†â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–…â–ˆâ–„â–„â–„â–„â–„â–„â–„â–ƒâ–„â–„â–„â–ƒâ–„â–„â–„â–„â–„â–ƒâ–ƒâ–„â–ƒâ–ƒâ–ƒâ–‚â–ƒâ–ƒâ–ƒâ–‚â–‚â–ƒâ–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚ â–ƒ
  1.41 ms        Histogram: frequency by time        1.59 ms &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯”ä¹‹å‰ç¨å¥½äº†ä¸€äº›ï¼Œå¤§çº¦æ˜¯ä¹‹å‰çš„5å€å·¦å³ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é¡ºæ‰‹åšäº›è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼ŒåŠ ä¸Š<code>@simd</code>å¹¶å»æ‰è¾¹ç•Œæ£€æŸ¥ï¼š</p><pre><code class="language-julia hljs">function dot2_3(x::AbstractArray{X}, y::AbstractArray{Y}) where {X,Y}
    res = zero(promote_type(X,Y))
    @inbounds @simd for i in eachindex(x, y)
        res += x[i] * y[i]
    end
    res
end</code></pre><pre><code class="language-julia hljs">julia&gt; @benchmark dot2_3($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 5545 samples with 1 evaluation.
 Range (min â€¦ max):  848.684 Î¼s â€¦  1.296 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     871.641 Î¼s              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   888.964 Î¼s Â± 50.935 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–‚â–‡â–ˆâ–‡â–†â–‡â–†â–…â–…â–…â–„â–„â–ƒâ–ƒâ–ƒâ–‚â–‚â–â–‚â–â–â–                                       â–‚
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–‡â–‡â–‡â–‡â–†â–†â–…â–…â–†â–†â–‡â–ˆâ–‡â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–‡â–ˆâ–‡â–…â–‡â–‡â–…â–…â–…â–„â–„â–…â–…â–…â–…â–…â–„â–ƒ â–ˆ
  849 Î¼s        Histogram: log(frequency) by time      1.11 ms &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>è¿™æ ·å·®è·è¿›ä¸€æ­¥ç¼©å°äº†ä¸€äº›ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥åˆ©ç”¨ <a href="https://github.com/JuliaSIMD/LoopVectorization.jl">LoopVectorization.jl</a> è¿™ä¸ªåº“æ¥æé€Ÿï¼š</p><pre><code class="language-julia hljs">using LoopVectorization
function dot2_4(x::AbstractArray{X}, y::AbstractArray{Y}) where {X,Y}
    res = zero(promote_type(X,Y))
    @turbo for i in eachindex(x, y)
        res += x[i] * y[i]
    end
    res
end</code></pre><pre><code class="language-julia hljs">julia&gt; @benchmark dot2_4($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 5905 samples with 1 evaluation.
 Range (min â€¦ max):  802.618 Î¼s â€¦  1.211 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     820.607 Î¼s              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   832.880 Î¼s Â± 39.868 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

   â–‚â–ˆâ–„                                                          
  â–‚â–ˆâ–ˆâ–ˆâ–†â–†â–‡â–…â–„â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â– â–‚
  803 Î¼s          Histogram: frequency by time         1.02 ms &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>çœ‹èµ·æ¥ç¨å¾®å¿«äº†ä¸€äº›ï¼Œä¸è¿‡ä¼¼ä¹ä»ç„¶ä¸<code>LinearAlgebra</code>ä¸­çš„æ€§èƒ½æœ‰3å€å¤šçš„æ€§èƒ½å·®è·ï¼Ÿå…¶å®ä¸ç„¶ï¼Œ<code>LinearAlgebra</code>ä¸­ä½¿ç”¨äº†BLASï¼Œè€Œå…¶é»˜è®¤æ˜¯æœ‰å¤šçº¿ç¨‹åŠ é€Ÿçš„ï¼Œä¸ºäº†å…¬å¹³æ¯”è¾ƒï¼Œå¯ä»¥å°†å…¶çº¿ç¨‹æ•°è®¾ç½®ä¸º1ï¼Œç„¶åå¯¹æ¯”ï¼š</p><pre><code class="language-julia hljs">julia&gt; LinearAlgebra.BLAS.set_num_threads(1)

julia&gt; @benchmark dot($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 5980 samples with 1 evaluation.
 Range (min â€¦ max):  795.374 Î¼s â€¦  1.104 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     811.659 Î¼s              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   823.303 Î¼s Â± 37.397 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

   â–…â–ˆ                                                           
  â–ƒâ–ˆâ–ˆâ–ˆâ–…â–‡â–‡â–…â–…â–„â–„â–„â–„â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚ â–ƒ
  795 Î¼s          Histogram: frequency by time         1.02 ms &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒäºŒè€…ç›¸å·®æ— å‡ ã€‚</p><h2 id="ç‰ˆæœ¬3ï¼š-ä¸€è¡Œä»£ç "><a class="docs-heading-anchor" href="#ç‰ˆæœ¬3ï¼š-ä¸€è¡Œä»£ç ">ç‰ˆæœ¬3ï¼š ä¸€è¡Œä»£ç </a><a id="ç‰ˆæœ¬3ï¼š-ä¸€è¡Œä»£ç -1"></a><a class="docs-heading-anchor-permalink" href="#ç‰ˆæœ¬3ï¼š-ä¸€è¡Œä»£ç " title="Permalink"></a></h2><p>å½“ç„¶ï¼Œæœ‰çš„æ—¶å€™å…¶å®å¯¹æ€§èƒ½ä¹Ÿä¸æ˜¯é‚£ä¹ˆå…³å¿ƒï¼Œåè€Œä»£ç çš„ç®€æ´æ€§æ›´é‡è¦ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç®€å•åœ°ç”¨ä¸€è¡Œä»£ç æ¥æå®šï¼š</p><pre><code class="language-julia hljs">julia&gt; @benchmark sum(a*b for (a,b) in zip($(rand(N)),$(rand(N))))
BenchmarkTools.Trial: 3823 samples with 1 evaluation.
 Range (min â€¦ max):  1.232 ms â€¦  1.840 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     1.281 ms              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   1.295 ms Â± 54.505 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

   â–ƒâ–ˆâ–‡â–„â–†â–‚                                                     
  â–ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–†â–‡â–„â–„â–„â–…â–…â–„â–…â–„â–…â–†â–†â–†â–…â–…â–†â–‡â–†â–†â–†â–„â–„â–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–â–â–â–â–â–â–â–â–â– â–ƒ
  1.23 ms        Histogram: frequency by time        1.46 ms &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>æˆ–è€…ï¼Œç›´æ¥ç”¨ <code>mapreduce</code>:</p><pre><code class="language-julia hljs">mapreduce(*, +, x, y)</code></pre><h2 id="ç‰ˆæœ¬4ï¼š-å¤šçº¿ç¨‹"><a class="docs-heading-anchor" href="#ç‰ˆæœ¬4ï¼š-å¤šçº¿ç¨‹">ç‰ˆæœ¬4ï¼š å¤šçº¿ç¨‹</a><a id="ç‰ˆæœ¬4ï¼š-å¤šçº¿ç¨‹-1"></a><a class="docs-heading-anchor-permalink" href="#ç‰ˆæœ¬4ï¼š-å¤šçº¿ç¨‹" title="Permalink"></a></h2><p>å—å‰é¢LinearAlgebraä¸­å¤šçº¿ç¨‹çš„å¯å‘ï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿå¯ä»¥ç”¨Juliaè‡ªå¸¦çš„å¤šçº¿ç¨‹å®Œæˆç‚¹ç§¯çš„è®¡ç®—ã€‚ä¸è¿‡éœ€è¦è®°å¾—åœ¨å¯åŠ¨Juliaçš„æ—¶å€™ï¼Œé€šè¿‡ <code>-t auto</code> æ¥æŒ‡å®šçº¿ç¨‹æ•°ã€‚</p><pre><code class="language-julia hljs">julia&gt; using Base.Threads

julia&gt; nthreads()
4</code></pre><p>è¿™é‡Œæˆ‘æœ¬æœºå°±4ä¸ªçº¿ç¨‹ã€‚æ‰€ä»¥</p><pre><code class="language-julia hljs">function dot4_1(x::AbstractArray{X}, y::AbstractArray{Y}) where {X,Y}
    res = zero(promote_type(X,Y))
    @threads for i in eachindex(x, y)
        res += x[i] * y[i]
    end
    res
end</code></pre><pre><code class="language-julia hljs">julia&gt; @benchmark dot4_1($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 109 samples with 1 evaluation.
 Range (min â€¦ max):  28.586 ms â€¦ 113.851 ms  â”Š GC (min â€¦ max):  0.00% â€¦ 62.77%
 Time  (median):     39.838 ms               â”Š GC (median):     0.00%
 Time  (mean Â± Ïƒ):   45.888 ms Â±  20.565 ms  â”Š GC (mean Â± Ïƒ):  14.59% Â± 19.04%

   â–      â–ˆâ–ƒ                                                    
  â–‡â–ˆâ–„â–ˆâ–†â–â–â–‡â–ˆâ–ˆâ–†â–‡â–„â–„â–„â–â–â–â–â–â–†â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–„â–â–â–â–„â–â–ˆâ–‡â–„ â–„
  28.6 ms       Histogram: log(frequency) by time       108 ms &lt;

 Memory estimate: 32.00 MiB, allocs estimate: 2097174.</code></pre><p>è¿™ä¸ªç»“æœå°±æ¯”è¾ƒæœ‰æ„æ€äº†ï¼Œç”±äºæˆ‘ä»¬çš„å¤šçº¿ç¨‹å®ç°å­˜åœ¨race condition, å®é™…ä¸Šå¾—åˆ°çš„ç»“æœå¹¶ä¸å¯¹ï¼Œå¹¶ä¸”é€Ÿåº¦ç›¸å½“æ…¢ã€‚å½“ç„¶ï¼Œä¸ºäº†ä¿è¯ç»“æœçš„æ­£ç¡®æ€§ï¼Œå¯ä»¥å¯¹<code>res</code>åŠ é”ï¼Œä½†å¹¶ä¸èƒ½å¸¦æ¥æ€§èƒ½ä¸Šçš„æå‡ã€‚ä¸€ä¸ªç®€å•çš„åŠæ³•æ˜¯ï¼Œå°†æ•°æ®åˆ†ç‰‡ï¼Œæ¯ä¸ªçº¿ç¨‹åšè‡ªå·±å•ç‹¬çš„è®¡ç®—ï¼Œæœ€åæŠŠå¤šä¸ªçº¿ç¨‹çš„ç»“æœåˆå¹¶ï¼š</p><pre><code class="language-julia hljs">function dot4_2(x::AbstractArray{X}, y::AbstractArray{Y}) where {X,Y}
    res = zeros(promote_type(X,Y), nthreads())
    @threads for i in 1:length(x)
        @inbounds res[threadid()] += x[i] * y[i]
    end
    sum(res)
end</code></pre><pre><code class="language-julia hljs">julia&gt; @benchmark dot4_2($(rand(N)), $(rand(N)))
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  378.194 Î¼s â€¦  16.460 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     397.990 Î¼s               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   433.403 Î¼s Â± 243.825 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–…â–ˆâ–†â–†â–†â–„â–‚â– â–â–      â–â–‚â–‚â– â–‚â–ƒâ–ƒâ–‚â–                                   â–‚
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–…â–†â–…â–…â–‡â–…â–â–ƒâ–â–ƒâ–ƒâ–â–„â–â–ƒâ–â–â–…â–‡â–„â–…â–ƒâ–ƒâ–„â–…â–„â–â–„â–„â–†â–…â–„â–… â–ˆ
  378 Î¼s        Histogram: log(frequency) by time        878 Î¼s &lt;

 Memory estimate: 1.98 KiB, allocs estimate: 22.</code></pre><p>è¿™æ ·å¾—åˆ°çš„ç»“æœï¼Œç›¸æ¯”å•çº¿ç¨‹çš„ç»“æœè¦å¿«äº†è¿‘3.2å€ã€‚</p><p>Juliaæ ‡å‡†åº“é‡Œæ²¡æœ‰æä¾›å¤šçº¿ç¨‹çš„æ±‚å’Œæ“ä½œï¼Œä¸è¿‡æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹åº“æä¾›äº†è¿™ç±»åŸºæœ¬æ“ä½œï¼Œæ¯”å¦‚<a href="https://github.com/tkf/ThreadsX.jl"><code>ThreadsX.jl</code></a>ã€‚</p><pre><code class="language-julia hljs">julia&gt; using ThreadsX

julia&gt; @benchmark ThreadsX.sum(a*b for (a,b) in zip($(rand(N)),$(rand(N))))
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  291.519 Î¼s â€¦  2.023 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     326.248 Î¼s              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   339.611 Î¼s Â± 42.828 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

        â–ƒâ–†â–ˆâ–†â–„â–‚â–                                                 
  â–â–‚â–ƒâ–…â–†â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–†â–†â–†â–†â–…â–„â–„â–„â–„â–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â– â–ƒ
  292 Î¼s          Histogram: frequency by time          472 Î¼s &lt;

 Memory estimate: 17.45 KiB, allocs estimate: 249.</code></pre><h2 id="ç‰ˆæœ¬5ï¼š-GPUç‰ˆ"><a class="docs-heading-anchor" href="#ç‰ˆæœ¬5ï¼š-GPUç‰ˆ">ç‰ˆæœ¬5ï¼š GPUç‰ˆ</a><a id="ç‰ˆæœ¬5ï¼š-GPUç‰ˆ-1"></a><a class="docs-heading-anchor-permalink" href="#ç‰ˆæœ¬5ï¼š-GPUç‰ˆ" title="Permalink"></a></h2><p>å¦‚æœä½ æ‰‹ä¸Šæ­£å¥½æœ‰å—GPUï¼Œä¸å¦¨è¯•è¯•çœ‹åœ¨GPUä¸Šåšç‚¹ç§¯ã€‚Juliaä¸­çš„<a href="https://github.com/JuliaGPU/CUDA.jl">CUDA.jl</a>æå¤§åœ°æ–¹ä¾¿äº†Juliaè¯­è¨€é‡Œçš„GPUç¼–ç¨‹ï¼Œé’ˆå¯¹ç‚¹ç§¯è¿™æ ·çš„å¸¸è§æ“ä½œï¼Œå…¶æä¾›äº†åŸºäºcuBLASçš„å°è£…ï¼Œä¸‹é¢æ¥è¯•ä¸‹ï¼š</p><pre><code class="language-julia hljs">julia&gt; using CUDA

julia&gt; @benchmark CUDA.@sync dot($(cu(rand(N))), $(cu(rand(N)))) 
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  26.521 Î¼s â€¦ 68.923 Î¼s  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     27.798 Î¼s              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   28.331 Î¼s Â±  1.494 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–‚â–   â–ƒâ–‡â–ˆâ–…â– â–ƒâ–…â–‡â–…â–‚   â–‚â–ƒ                                       â–‚
  â–ˆâ–ˆâ–ˆâ–†â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–ˆâ–ˆâ–ˆâ–ˆâ–†â–„â–„â–…â–†â–†â–…â–…â–…â–…â–…â–…â–…â–†â–†â–†â–†â–…â–†â–„â–…â–†â–…â–„â–…â–…â–‚â–…â–„â–„â–…â–…â–„â–„â–ƒâ–…â–„ â–ˆ
  26.5 Î¼s      Histogram: log(frequency) by time      35.9 Î¼s &lt;

 Memory estimate: 16 bytes, allocs estimate: 1.</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶é€Ÿåº¦ç›¸å½“å¿«ã€‚</p><p>ä¸è¿‡ï¼Œç”±äºcuBLASé‡Œçš„<code>dot</code>åªé’ˆå¯¹å¸¸è§çš„ <code>Float32</code>, <code>Float64</code>, <code>Float16</code> ä»¥åŠå¯¹åº”çš„å¤æ•°ç±»å‹çš„GPUä¸Šçš„å‘é‡æœ‰å®ç°ï¼Œå½“è¾“å…¥çš„ä¸¤ä¸ªå‘é‡çš„å…ƒç´ ç±»å‹ä¸ä¸€è‡´æ—¶ï¼Œç›®å‰çš„CUDA.jl(v3.5.0)ä¼šfallbackåˆ°CPUç‰ˆæœ¬çš„å®ç°ï¼Œå¯¼è‡´æ€§èƒ½ææ…¢ï¼š</p><pre><code class="language-julia hljs">julia&gt; z = rand(Bool, N);

julia&gt; cx, cz = cu(x), cu(z);

julia&gt; @time dot(cx, cz)
â”Œ Warning: Performing scalar indexing on task Task (runnable) @0x00007f63cc0c0010.
â”‚ Invocation of getindex resulted in scalar indexing of a GPU array.
â”‚ This is typically caused by calling an iterating implementation of a method.
â”‚ Such implementations *do not* execute on the GPU, but very slowly on the CPU,
â”‚ and therefore are only permitted from the REPL for prototyping purposes.
â”‚ If you did intend to index this array, annotate the caller with @allowscalar.
â”” @ GPUArrays ~/.julia/packages/GPUArrays/3sW6s/src/host/indexing.jl:56
 12.914170 seconds (6.29 M allocations: 1.000 GiB, 0.87% gc time)</code></pre><p>ä¸€ä¸ªç®€å•çš„workaroundæ˜¯ï¼Œå…ˆæŠŠç±»å‹ä¸åŒçš„ä¸¤ä¸ªå‘é‡è½¬æ¢æˆç›¸åŒçš„ç±»å‹ï¼Œç„¶åå†è°ƒç”¨<code>dot</code>å‡½æ•°ï¼š</p><pre><code class="language-julia hljs">julia&gt; @benchmark CUDA.@sync dot($(cu(rand(N))), convert(CuArray{Float32}, $(cu(rand(Bool, N)))))
BenchmarkTools.Trial: 3968 samples with 1 evaluation.
 Range (min â€¦ max):  1.073 ms â€¦   4.408 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 30.06%
 Time  (median):     1.140 ms               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   1.252 ms Â± 464.709 Î¼s  â”Š GC (mean Â± Ïƒ):  3.35% Â±  6.05%

  â–‚â–ˆâ–ƒ  â–„â–                                     â–                
  â–ˆâ–ˆâ–ˆâ–‡â–†â–ˆâ–ˆâ–†â–„â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–„â–ˆâ–…â–ƒâ–â–ƒâ–â–â–â–ƒâ–â–ƒâ–â–â–â–ˆ â–ˆ
  1.07 ms      Histogram: log(frequency) by time      3.85 ms &lt;

 Memory estimate: 5.00 MiB, allocs estimate: 12.</code></pre><p>ç›¸æ¯”åŸæ¥çš„GPUç‰ˆæœ¬ï¼Œå¤šå‡ºæ¥äº†ä¸€æ¬¡æ‹·è´æ•°æ®çš„æ—¶é—´ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ ä¸è¿‡ï¼Œ<code>CUDA.jl</code>çš„å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œé’ˆå¯¹è¿™ç±»æ²¡æœ‰å†…ç½®çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥<em>å¾ˆå®¹æ˜“åœ°</em>é€šè¿‡ç¼–å†™è‡ªå®šä¹‰çš„æ ¸å‡½æ•°æ¥å®ç°ã€‚</p><pre><code class="language-julia hljs">function dot5_1(x::CuArray{T1}, y::CuArray{T2}) where {T1, T2}
    T = promote_type(T1, T2)
    res = CuArray{T}([zero(T)])
    function kernel(x, y, res)
        for i in 1:length(x)
            @inbounds res[] += x[i] * y[i]
        end
    end
    @cuda kernel(x, y, res)
    res[]
end</code></pre><p>è‡ªå·±æ‰‹å†™æ ¸å‡½æ•°ç»å¸¸å®¹æ˜“å‡ºç°å„ç§bugï¼Œæ‰€ä»¥é¦–è¦ä»»åŠ¡æ˜¯å…ˆç¡®è®¤æˆ‘ä»¬è®¡ç®—çš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼š</p><pre><code class="language-julia hljs">julia&gt; isapprox(dot5_1(cx, cz), dot(cx, convert(CuArray{Float32}, cz)))
true</code></pre><p>æ³¨æ„è¿™é‡Œç”¨çš„æ˜¯<code>isapprox</code>æ¥åšæ¯”è¾ƒã€‚çœ‹èµ·æ¥æˆ‘ä»¬å¾—åˆ°çš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå…¶æ€§èƒ½å¦‚ä½•å‘¢ï¼Ÿ</p><pre><code class="language-julia hljs">julia&gt; @benchmark CUDA.@sync dot5_1($(cu(rand(N))), $(cu(rand(Bool, N))))
BenchmarkTools.Trial: 103 samples with 1 evaluation.
 Range (min â€¦ max):  48.510 ms â€¦  54.895 ms  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     48.514 ms               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   48.606 ms Â± 657.494 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–ˆâ–                                                            
  â–ˆâ–ˆâ–ˆâ–â–â–„â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–„ â–„
  48.5 ms       Histogram: log(frequency) by time      50.6 ms &lt;

 Memory estimate: 1.78 KiB, allocs estimate: 29.</code></pre><p>å‘ƒï¼Œè¿˜ä¸å¦‚å…ˆ<code>convert</code>äº†å†è°ƒç”¨è‡ªå¸¦çš„<code>dot</code>å‡½æ•°...... é‚£é—®é¢˜å‡ºåœ¨å“ªå‘¢ï¼Ÿå…¶å®ä¸Šé¢çš„æ ¸å‡½æ•°åªç”¨äº†ä¸€ä¸ªçº¿ç¨‹åœ¨è®¡ç®—ï¼Œä½†æ˜¯åœ¨GPUä¸Šæœ‰å¤§é‡çš„çº¿ç¨‹å¯ä¾›è®¡ç®—ï¼Œäºæ˜¯ï¼Œå¯ä»¥é‡‡ç”¨ä¸Šé¢çš„CPUä¸Šå¤šçº¿ç¨‹çš„æ–¹æ³•æ¥è®¡ç®—ï¼š</p><pre><code class="language-julia hljs">function dot5_2(x::CuArray{T1}, y::CuArray{T2}) where {T1, T2}
    T = promote_type(T1, T2)
    res = CuArray{T}([zero(T)])
    function kernel(x, y, res)
        index = threadIdx().x
        stride = blockDim().x
        for i in index:stride:length(x)
            @inbounds res[] += x[i] * y[i]
        end
    end
    k = @cuda launch=false kernel(x, y, res)
    config = launch_configuration(k.fun)
    k(x, y, res; threads=min(length(x), config.threads))
    CUDA.@allowscalar res[]
end</code></pre><p>è¿™é‡Œåœ¨è¿è¡Œæ ¸å‡½æ•°çš„æ—¶å€™ï¼ŒæŒ‡å®šäº†<code>threads</code>çš„ä¸ªæ•°ï¼Œåœ¨æ ¸å‡½æ•°å†…éƒ¨çš„<code>for</code>å¾ªç¯æŠŠæ•°æ®æ ¹æ®<code>threads</code>åˆ‡åˆ†æˆäº†ä¸åŒçš„ç‰‡æ®µï¼Œæ¯ä¸ªthreadè´Ÿè´£è®¡ç®—å„è‡ªçš„ä¸€éƒ¨åˆ†ã€‚ å…ˆéªŒè¯ä¸‹æ­£ç¡®æ€§ï¼š</p><pre><code class="language-julia hljs">julia&gt; isapprox(dot5_2(cx, cz), dot(cx, convert(CuArray{Float32}, cz)))
false</code></pre><p>ç­‰ç­‰ï¼Œè¿™é‡Œä¼¼ä¹çŠ¯äº†å’Œå‰é¢å¤šçº¿ç¨‹è®¡ç®—æ—¶å€™ä¸€æ ·çš„é”™è¯¯ï¼Œåœ¨å¾€<code>res</code>é‡Œç´¯ç§¯æ±‚å’Œçš„æ—¶å€™ï¼Œä¼šå­˜åœ¨é™æ€æ¡ä»¶ã€‚ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä¸ç”¨æ¯æ¬¡éƒ½å¾€<code>res</code>é‡Œå†™å…¥ç»“æœï¼Œåªéœ€è¦åœ¨æ¯ä¸ªçº¿ç¨‹å†…éƒ¨å…ˆè®¡ç®—å®Œï¼Œæœ€åå åŠ ä¸Šå»å³å¯ï¼ŒåŒæ—¶æœ€åè¦åŠ é”ã€‚</p><pre><code class="language-julia hljs">function dot5_3(x::CuArray{T1}, y::CuArray{T2}) where {T1, T2}
    T = promote_type(T1, T2)
    res = CuArray{T}([zero(T)])
    function kernel(x, y, res, T)
        index = threadIdx().x
        stride = blockDim().x
        s = zero(T)
        for i in index:stride:length(x)
            @inbounds s += x[i] * y[i]
        end
        CUDA.@atomic res[] += s
        return nothing
    end
    k = @cuda launch=false kernel(x, y, res,T)
    config = launch_configuration(k.fun)
    k(x, y, res, T; threads=min(length(x), config.threads))
    CUDA.@allowscalar res[]
end</code></pre><p>è¿™é‡Œç”¨äº†<code>CUDA.@atomic</code>æ¥ä¿è¯åŸå­æ“ä½œï¼ŒåŒæ ·ï¼Œå…ˆç¡®è®¤è®¡ç®—çš„æ­£ç¡®æ€§ï¼š</p><pre><code class="language-julia hljs">julia&gt; isapprox(dot(cx, cz), dot5_3(cx, cz))
true</code></pre><p>å†çœ‹ä¸‹é€Ÿåº¦å¦‚ä½•ï¼š</p><pre><code class="language-julia hljs">julia&gt; @benchmark CUDA.@sync dot5_3($(cu(rand(N))), $(cu(rand(Bool, N))))
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  175.298 Î¼s â€¦ 448.774 Î¼s  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     178.373 Î¼s               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   179.218 Î¼s Â±   4.301 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

    â–â–ƒâ–…â–…â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–‡â–‡â–‡â–‡â–†â–†â–…â–…â–„â–„â–ƒâ–‚â–‚â–â–â–â– â–   â–â–â–â–â– â–â–â–â–â–â–â–              â–ƒ
  â–…â–…â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–ˆâ–ˆâ–‡â–‡â–†â–‡â–†â–…â–…â–‡â–…â–† â–ˆ
  175 Î¼s        Histogram: log(frequency) by time        191 Î¼s &lt;

 Memory estimate: 2.16 KiB, allocs estimate: 39.</code></pre><p>è¿˜ä¸é”™ï¼Œè‡³å°‘æ¯”CPUç‰ˆæœ¬å¿«äº†ï¼Œä½†æ˜¯ç¦»CUBLASç‰ˆæœ¬çš„æ€§èƒ½è¿˜æœ‰ä¸€å®šå·®è·ã€‚</p><p>è€ƒè™‘åˆ°ä¸€å—GPUä¸­ï¼Œè¿˜ä¼šæœ‰å¤šä¸ªblockï¼Œè€Œä¸Šé¢æˆ‘ä»¬æ‰ç”¨äº†å…¶ä¸­çš„ä¸€ä¸ªblockï¼Œæ˜¾ç„¶è¿˜æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ï¼</p><p>ä¸€ä¸ªåŸºæœ¬æ€è·¯æ˜¯ï¼Œæ ¹æ®è¾“å…¥çš„æ•°æ®ï¼Œåˆ†é…å¤šä¸ªblockï¼Œåœ¨æ¯ä¸ªblockçš„æ•°æ®åŒºå—ä¸­ï¼ŒæŒ‰threadå†åˆ‡åˆ†ä¸€æ¬¡ï¼Œæ¯ä¸ªthreadè®¡ç®—è‡ªå·±æ‰€å±çš„æ•°æ®çš„ç‚¹ç§¯ä¹‹å’Œã€‚</p><pre><code class="language-julia hljs">function dot5_4(x::CuArray{T1}, y::CuArray{T2}) where {T1, T2}
    T = promote_type(T1, T2)
    res = CuArray{T}([zero(T)])
    function kernel(x, y, res, T)
        index = threadIdx().x
        thread_stride = blockDim().x
        block_stride = (length(x)-1) Ã· gridDim().x + 1
        start = (blockIdx().x - 1) * block_stride + 1
        stop = blockIdx().x * block_stride

        s = zero(T)
        for i in start-1+index:thread_stride:stop
            @inbounds s += x[i] * y[i]
        end
        CUDA.@atomic res[] += s
        return nothing
    end
    k = @cuda launch=false kernel(x, y, res,T)
    config = launch_configuration(k.fun)
    k(x, y, res, T; threads=min(length(x), config.threads), blocks=config.blocks)
    CUDA.@allowscalar res[]
end</code></pre><pre><code class="language-julia hljs">julia&gt; isapprox(dot(cx, cz), dot5_4(cx, cz))
true

julia&gt; @benchmark CUDA.@sync dot5_4($(cu(rand(N))), $(cu(rand(Bool, N))))
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  134.011 Î¼s â€¦ 383.172 Î¼s  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     134.933 Î¼s               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   135.095 Î¼s Â±   2.723 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

       â–â–ƒâ–„â–‡â–‡â–‡â–†â–ˆâ–ˆâ–ˆâ–ˆâ–‡â–†â–ƒâ–ƒâ–                                          
  â–‚â–‚â–ƒâ–…â–†â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–†â–…â–…â–…â–„â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚ â–„
  134 Î¼s           Histogram: frequency by time          138 Î¼s &lt;

 Memory estimate: 2.16 KiB, allocs estimate: 39.</code></pre><p>OK, çœ‹èµ·æ¥ç¨å¾®å¿«äº†ä¸€äº›ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰é¢æˆ‘ä»¬ç›´æ¥å°†æ¯ä¸ªthreadè®¡ç®—çš„ç»“æœå¾€ä¸€ä¸ª<code>res</code>å¯¹è±¡ä¸­é€šè¿‡åŠ é”å åŠ ä¸Šå»äº†ï¼Œè¿™æ ·å¯¼è‡´æ¯ä¸ªblockä¸­æ¯ä¸ªthreadéƒ½ä¼šå¡åœ¨åŸå­æ“ä½œé‚£ä¸€æ­¥ã€‚ ä¸€ç§ä¼˜åŒ–æ–¹å¼æ˜¯æ¯ä¸ªblockçš„å†…éƒ¨ï¼Œå…ˆæŠŠå„ä¸ªthreadçš„è®¡ç®—ç»“æœç¼“å­˜èµ·æ¥ï¼Œç­‰ä¸€ä¸ªblockå†…æ‰€æœ‰threadéƒ½è®¡ç®—å‡ºæ¥äº†åŒæ­¥ä¸€ä¸‹ï¼Œç„¶åå†…éƒ¨å…ˆreduceï¼Œæœ€åå†é€šè¿‡åŸå­æ“ä½œåŒæ­¥åˆ°æœ€ç»ˆçš„ç»“æœä¸Šã€‚</p><pre><code class="language-julia hljs">function dot5_5(x::CuArray{T1}, y::CuArray{T2}) where {T1, T2}
    T = promote_type(T1, T2)
    res = CuArray{T}([zero(T)])
    function kernel(x, y, res, T)
        index = threadIdx().x
        thread_stride = blockDim().x
        block_stride = (length(x)-1) Ã· gridDim().x + 1
        start = (blockIdx().x - 1) * block_stride + 1
        stop = blockIdx().x * block_stride

        cache = CuDynamicSharedArray(T, (thread_stride,))

        for i in start-1+index:thread_stride:stop
            @inbounds cache[index] += x[i] * y[i]
        end

        sync_threads()

        if index == 1
            s = zero(T)
            for i in 1:thread_stride
                s += cache[i]
            end
            CUDA.@atomic res[] += s
        end
        return nothing
    end
    k = @cuda launch=false kernel(x, y, res,T)
    config = launch_configuration(k.fun; shmem=(threads) -&gt; threads*sizeof(T))
    threads = min(length(x), config.threads)
    blocks = config.blocks
    k(x, y, res, T; threads=threads, blocks=config.blocks, shmem=threads*sizeof(T))
    CUDA.@allowscalar res[]
end</code></pre><pre><code class="language-julia hljs">julia&gt; isapprox(dot(cx, cz), dot5_5(cx, cz))
true

julia&gt; @benchmark CUDA.@sync dot5_5($(cu(rand(N))), $(cu(rand(Bool, N))))
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  54.364 Î¼s â€¦ 358.597 Î¼s  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     55.217 Î¼s               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   55.559 Î¼s Â±   4.023 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

     â–„â–‡â–ˆâ–‡â–…â–ƒâ–‚                                                    
  â–‚â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–‡â–†â–…â–„â–„â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–â–‚ â–ƒ
  54.4 Î¼s         Histogram: frequency by time         61.3 Î¼s &lt;

 Memory estimate: 2.33 KiB, allocs estimate: 43.</code></pre><p>å¯ä»¥çœ‹åˆ°,å…¶æ€§èƒ½è·ŸCUBLASæ¯”è¾ƒæ¥è¿‘äº†ã€‚å½“ç„¶ï¼Œä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä¸Šé¢æœ€åreduceçš„æ—¶å€™ï¼Œåªæœ‰indexä¸º1çš„çº¿ç¨‹åœ¨è¿è¡Œï¼Œå…¶å®å¯ä»¥å¤šä¸ªçº¿ç¨‹ä¸€èµ·å·¥ä½œï¼š</p><pre><code class="language-julia hljs">using CUDA:i32

function dot5_6(x::CuArray{T1}, y::CuArray{T2}) where {T1, T2}
    T = promote_type(T1, T2)
    res = CuArray{T}([zero(T)])
    function kernel(x, y, res, T)
        index = threadIdx().x
        thread_stride = blockDim().x
        block_stride = (length(x)-1i32) Ã· gridDim().x + 1i32
        start = (blockIdx().x - 1i32) * block_stride + 1i32
        stop = blockIdx().x * block_stride

        cache = CuDynamicSharedArray(T, (thread_stride,))

        for i in start-1i32+index:thread_stride:stop
            @inbounds cache[index] += x[i] * y[i]
        end
        sync_threads()

        mid = thread_stride
        while true
            mid = (mid - 1i32) Ã· 2i32 + 1i32
            if index &lt;= mid
                @inbounds cache[index] += cache[index+mid]
            end
            sync_threads()
            mid == 1i32 &amp;&amp; break
        end

        if index == 1i32
            CUDA.@atomic res[] += cache[1]
        end
        return nothing
    end
    k = @cuda launch=false kernel(x, y, res,T)
    config = launch_configuration(k.fun; shmem=(threads) -&gt; threads*sizeof(T))
    threads = min(length(x), config.threads)
    blocks = config.blocks
    k(x, y, res, T; threads=threads, blocks=config.blocks, shmem=threads*sizeof(T))
    CUDA.@allowscalar res[]
end</code></pre><pre><code class="language-julia hljs">julia&gt; isapprox(dot(cx, cz), dot5_6(cx, cz))
true

julia&gt; @benchmark CUDA.@sync dot5_6($(cu(rand(N))), $(cu(rand(Bool, N))))
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  22.520 Î¼s â€¦ 375.954 Î¼s  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     23.475 Î¼s               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   23.762 Î¼s Â±   3.748 Î¼s  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

        â–â–…â–ˆâ–ˆâ–†â–ƒâ–                                                 
  â–‚â–‚â–ƒâ–ƒâ–„â–†â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–…â–„â–…â–…â–…â–†â–…â–„â–„â–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚ â–ƒ
  22.5 Î¼s         Histogram: frequency by time           28 Î¼s &lt;

 Memory estimate: 2.16 KiB, allocs estimate: 39.</code></pre><p>è¿™æ ·ï¼Œæœ€ç»ˆçš„ç»“æœè·ŸCUBLASçš„æ€§èƒ½åŸºæœ¬ä¸€è‡´äº†ã€‚</p><p>ä»ä»£ç å±‚é¢ä¸Šè®²ï¼Œä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä¸‹ï¼Œä¸Šé¢çš„whileå¾ªç¯å…¶å®æ˜¯ä¸€ä¸ªç»å…¸çš„reduceæ“ä½œï¼Œè€Œ<code>CUDA.jl</code>ä¸­å†…ç½®äº†ä¸€ä¸ªå‡½æ•°<code>reduce_block</code>æ¥ç®€åŒ–è¯¥æ“ä½œï¼Œä¸‹é¢æ˜¯ç®€åŒ–åçš„æ ¸å‡½æ•°å†™æ³•ï¼š</p><pre><code class="language-julia hljs">    function kernel(x, y, res::AbstractArray{T}, shuffle) where {T}
        local_val = zero(T)

        # grid-stride loop
        i = threadIdx().x + (blockIdx().x - 1i32)*blockDim().x
        while i &lt;= length(x)
            @inbounds local_val += dot(x[i], y[i])
            i += blockDim().x * gridDim().x
        end

        val = reduce_block(+, local_val, zero(T), shuffle)
        if threadIdx().x == 1i32
            # NOTE: introduces nondeterminism
            @inbounds @atomic res[] += val
        end

        return
    end</code></pre><div class="code_snippet_title">
â¤ï¸
Source: <a href="https://github.com/JuliaGPU/CUDA.jl/blob/262c183b6f0480a105e0ca7761e43f435d9eb269/src/linalg.jl#L73-L90">linalg.jl</a>
â¤ï¸
</div>
<p>å¿˜äº†è¯´äº†ï¼Œå¦‚æœä½ è¿˜æ˜¯one-line solutionçš„çˆ±å¥½è€…ï¼Œå…¶å®ä¹‹å‰çš„CPUç‰ˆæœ¬çš„å†™æ³•åœ¨GPUä¸ŠåŒæ ·workå“¦~</p><pre><code class="language-julia hljs">mapreduce((x,y)-&gt;dot(x, y), +, x, y)</code></pre><h2 id="å‚è€ƒ"><a class="docs-heading-anchor" href="#å‚è€ƒ">å‚è€ƒ</a><a id="å‚è€ƒ-1"></a><a class="docs-heading-anchor-permalink" href="#å‚è€ƒ" title="Permalink"></a></h2><ul><li><a href="https://cuda.juliagpu.org/stable/tutorials/introduction/">Introduction to CUDA.jl</a></li><li><a href="https://www.nvidia.com/content/GTC-2010/pdfs/2131_GTC2010.pdf">GTC-2010</a></li><li><a href="https://github.com/JuliaGPU/CUDA.jl/pull/1240">CUDA.jl#1240</a></li></ul><script src="https://utteranc.es/client.js"
        repo="findmyway/TianJun.jl"
        issue-term="url"
        label="ğŸ’¬Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>. All contents published at this site follows <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a> by default. For the Chinese version, please visit <a href="https://tianjun.me">tianjun.me</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Saturday 23 December 2023 15:51">Saturday 23 December 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
